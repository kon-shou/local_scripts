#!/bin/bash

# ãƒ˜ãƒ«ãƒ—é–¢æ•°
show_help() {
  cat << EOF
Usage: $0 [OPTIONS]

Calculate contribution share for Git repositories.

Options:
  --months-ago=N        Calculate statistics for the last N months
  --months-ago N        (alternative format)
  --since=YYYY-MM-DD    Calculate statistics since the specified date
  --since YYYY-MM-DD    (alternative format)
  -h, --help            Show this help message

Priority (when multiple sources are specified):
  1. --since option (highest)
  2. --months-ago option
  3. Positional argument (deprecated, no longer supported)
  4. STATS_GITHUB_SINCE_DATE environment variable (deprecated)

Examples:
  $0 --months-ago=12
  $0 --since=2024-01-01

Environment Variables:
  REPOS                 List of repositories to analyze (required)
  REPOS_BASE_PATH       Base directory for repositories (required)
  STATS_GITHUB_AUTHOR_PATTERN  Author pattern to match (required)
  STATS_GITHUB_SINCE_DATE  Default since date (deprecated, lowest priority)
  REPO_AUTHORS_EXCLUDE_PATTERN  Pattern to exclude from statistics
  REPO_AUTHORS_MAX_LINES  Maximum lines threshold (default: 50000)
  STATS_GITHUB_MASTER_REPOS  Space-separated list of repos using 'master' branch

Description:
  This script calculates your contribution share across multiple
  Git repositories, showing both per-repository and overall statistics.
EOF
}

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
MONTHS_AGO=""
SINCE_DATE=""

# ã‚ªãƒ—ã‚·ãƒ§ãƒ³è§£æ
while [[ $# -gt 0 ]]; do
  case $1 in
    --months-ago)
      MONTHS_AGO="$2"
      shift 2
      ;;
    --months-ago=*)
      MONTHS_AGO="${1#*=}"
      shift
      ;;
    --since)
      SINCE_DATE="$2"
      shift 2
      ;;
    --since=*)
      SINCE_DATE="${1#*=}"
      shift
      ;;
    -h|--help)
      show_help
      exit 0
      ;;
    -*)
      echo "Error: Unknown option: $1" >&2
      echo "Try '$0 --help' for more information." >&2
      exit 1
      ;;
    *)
      # ä½ç½®å¼•æ•°ã¯ã‚¨ãƒ©ãƒ¼ï¼ˆå¾Œæ–¹äº’æ›æ€§ãªã—ï¼‰
      echo "Error: Unexpected argument: $1" >&2
      echo "Use --months-ago or --since option instead." >&2
      echo "Try '$0 --help' for more information." >&2
      exit 1
      ;;
  esac
done

# å„ªå…ˆé †ä½ã«åŸºã¥ãå‡¦ç†
# 1. --since ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆæœ€å„ªå…ˆï¼‰
# 2. --months-ago ã‚ªãƒ—ã‚·ãƒ§ãƒ³
# 3. STATS_GITHUB_SINCE_DATE ç’°å¢ƒå¤‰æ•°ï¼ˆæœ€ä½å„ªå…ˆåº¦ï¼‰

if [ -n "$SINCE_DATE" ]; then
  # --since ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹ï¼ˆæœ€å„ªå…ˆï¼‰
  # æ—¥ä»˜å½¢å¼ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  if ! [[ "$SINCE_DATE" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
    echo "Error: --since must be in YYYY-MM-DD format" >&2
    exit 1
  fi
  # æœ‰åŠ¹ãªæ—¥ä»˜ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆmacOS/Linuxä¸¡å¯¾å¿œï¼‰
  if date -j -f "%Y-%m-%d" "$SINCE_DATE" > /dev/null 2>&1; then
    : # macOS: æ—¥ä»˜ãŒæœ‰åŠ¹
  elif date -d "$SINCE_DATE" > /dev/null 2>&1; then
    : # Linux: æ—¥ä»˜ãŒæœ‰åŠ¹
  else
    echo "Error: Invalid date: $SINCE_DATE" >&2
    exit 1
  fi
elif [ -n "$MONTHS_AGO" ]; then
  # --months-ago ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹
  # æ•°å€¤ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  if ! [[ "$MONTHS_AGO" =~ ^[0-9]+$ ]]; then
    echo "Error: --months-ago must be a positive integer" >&2
    exit 1
  fi
  # SINCE_DATE ã‚’è¨ˆç®—ï¼ˆmacOS/Linuxä¸¡å¯¾å¿œï¼‰
  if date -v -${MONTHS_AGO}m > /dev/null 2>&1; then
    SINCE_DATE=$(date -v -${MONTHS_AGO}m +%Y-%m-%d)
  else
    SINCE_DATE=$(date -d "${MONTHS_AGO} months ago" +%Y-%m-%d)
  fi
elif [ -n "${STATS_GITHUB_SINCE_DATE}" ]; then
  # ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ï¼ˆæœ€ä½å„ªå…ˆåº¦ã€éæ¨å¥¨ï¼‰
  echo "Warning: STATS_GITHUB_SINCE_DATE environment variable is deprecated. Use --since option instead." >&2
  SINCE_DATE="${STATS_GITHUB_SINCE_DATE}"
else
  # ã„ãšã‚Œã‚‚æŒ‡å®šã•ã‚Œã¦ã„ãªã„
  echo "Error: Either --months-ago or --since is required" >&2
  echo "Try '$0 --help' for more information." >&2
  exit 1
fi

# ==========================================
# ã€è¨­å®šã€‘ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆç’°å¢ƒå¤‰æ•°ã§ä¸Šæ›¸ãå¯èƒ½ï¼‰
# ==========================================
REPOS="${REPOS}"
LOCAL_ROOT="${REPOS_BASE_PATH}"
GIT_AUTHOR="${STATS_GITHUB_AUTHOR_PATTERN}"
EXCLUDE_PATTERN="${REPO_AUTHORS_EXCLUDE_PATTERN}"
MAX_LINES_LIMIT="${REPO_AUTHORS_MAX_LINES:-50000}"
MASTER_REPOS="${STATS_GITHUB_MASTER_REPOS}"
# ==========================================

ALL_LOGS=$(mktemp)

echo "ğŸ“Š è²¢çŒ®ã‚·ã‚§ã‚¢ç‡é›†è¨ˆ (${SINCE_DATE} ã€œ æœ¬æ—¥)"
echo "ğŸ‘¤ User: \"$GIT_AUTHOR\""
echo "ğŸ“¡ Action: æœ€æ–°ã® origin/master(main) ã‚’å–å¾—ã—ã¦é›†è¨ˆ"
echo "âš ï¸  1ãƒ•ã‚¡ã‚¤ãƒ« ${MAX_LINES_LIMIT}è¡Œä»¥ä¸Šã®å¤‰æ›´ã¯é™¤å¤–"
echo "-----------------------------------------------------------------------------------------"
printf "%-20s | %-7s | %10s | %10s | %7s | %s\n" "Repository" "Branch" "My Lines" "Total Lines" "Share" "Note"
echo "-----------------------------------------------------------------------------------------"

grand_my_lines=0
grand_total_lines=0

for repo in $REPOS; do
    repo_path="${LOCAL_ROOT}/${repo}"

    # ãƒ–ãƒ©ãƒ³ãƒåˆ¤å®šï¼ˆç’°å¢ƒå¤‰æ•°åŒ–ï¼‰
    if echo " ${MASTER_REPOS} " | grep -q " ${repo} "; then
        TARGET_BRANCH="master"
    else
        TARGET_BRANCH="main"
    fi

    # é›†è¨ˆå¯¾è±¡ã‚’ãƒªãƒ¢ãƒ¼ãƒˆè¿½è·¡ãƒ–ãƒ©ãƒ³ãƒã«ã™ã‚‹ (origin/master)
    TARGET_REF="origin/$TARGET_BRANCH"

    if [ -d "$repo_path/.git" ]; then
        # ---------------------------------------------------------
        # 0. æœ€æ–°æƒ…å ±ã‚’å–å¾— (Fetch)
        # ---------------------------------------------------------
        git -C "$repo_path" fetch origin "$TARGET_BRANCH" >/dev/null 2>&1

        # æŒ‡å®šãƒ–ãƒ©ãƒ³ãƒ(ãƒªãƒ¢ãƒ¼ãƒˆ)ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        if ! git -C "$repo_path" rev-parse --verify "$TARGET_REF" >/dev/null 2>&1; then
            printf "%-20s | %-7s |      -     |      -     |    -   | (Remote branch not found)\n" "${repo:0:20}" "$TARGET_BRANCH"
            continue
        fi

        # ---------------------------------------------------------
        # 1. è‡ªåˆ†ã®è¡Œæ•°ã‚’è¨ˆç®—
        # ---------------------------------------------------------

        # ãƒ­ã‚°ä¿å­˜ (æ‹¡å¼µå­é›†è¨ˆç”¨)
        git -C "$repo_path" log "$TARGET_REF" --author="$GIT_AUTHOR" -i --since="$SINCE_DATE" --no-merges --numstat --format="" --no-renames \
            | grep -vE "$EXCLUDE_PATTERN" \
            | awk -v limit="$MAX_LINES_LIMIT" '{ if ($1 ~ /^[0-9]+$/ && ($1+$2) <= limit) print $0 }' \
            >> "$ALL_LOGS"

        # æ•°å€¤è¨ˆç®— & é™¤å¤–ãƒ•ã‚¡ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯
        output_me=$(git -C "$repo_path" log "$TARGET_REF" --author="$GIT_AUTHOR" -i --since="$SINCE_DATE" --no-merges --numstat --format="" --no-renames \
            | grep -vE "$EXCLUDE_PATTERN" \
            | awk -v limit="$MAX_LINES_LIMIT" '
                BEGIN {sum=0; skip=0; files=""}
                {
                    if ($1 !~ /^[0-9]+$/) next;
                    lines = $1 + $2;

                    if (lines > limit) {
                        skip++;
                        entry = $3 ": " lines;
                        if (files == "") files = entry;
                        else files = files ", " entry;
                    }
                    else {
                        sum += lines;
                    }
                }
                END {printf "%d\t%d\t%s", sum, skip, files}'
        )

        IFS=$'\t' read my_lines my_skip my_ignored_files <<< "$output_me"
        unset IFS

        # ---------------------------------------------------------
        # 2. å…¨ä½“ã®è¡Œæ•°ã‚’è¨ˆç®—
        # ---------------------------------------------------------
        output_total=$(git -C "$repo_path" log "$TARGET_REF" --since="$SINCE_DATE" --no-merges --numstat --format="" --no-renames \
            | grep -vE "$EXCLUDE_PATTERN" \
            | awk -v limit="$MAX_LINES_LIMIT" '
                BEGIN {sum=0}
                {
                    if ($1 !~ /^[0-9]+$/) next;
                    if (($1+$2) <= limit) sum+=$1+$2
                }
                END {printf "%d", sum}'
        )
        total_lines="$output_total"

        # 3. ã‚·ã‚§ã‚¢ç‡ & Noteè¡¨ç¤º
        if [ "$total_lines" -gt 0 ]; then
            share=$(awk "BEGIN {printf \"%.1f\", ($my_lines / $total_lines) * 100}")
        else
            share="0.0"
        fi

        note=""
        if [ "$my_skip" -gt 0 ]; then
            note="(${my_skip} ignored: ${my_ignored_files})"
        fi

        printf "%-20s | %-7s | %10s | %10s | %6s%% | %s\n" \
            "${repo:0:20}" "$TARGET_BRANCH" "$(printf "%'d" $my_lines)" "$(printf "%'d" $total_lines)" "$share" "$note"

        grand_my_lines=$((grand_my_lines + my_lines))
        grand_total_lines=$((grand_total_lines + total_lines))
    else
        printf "%-20s | %-7s |      -     |      -     |    -   | (Repo not found)\n" "${repo:0:20}" "$TARGET_BRANCH"
    fi
done

echo "-----------------------------------------------------------------------------------------"

if [ "$grand_total_lines" -gt 0 ]; then
    grand_share=$(awk "BEGIN {printf \"%.1f\", ($grand_my_lines / $grand_total_lines) * 100}")
else
    grand_share="0.0"
fi

echo "ğŸ“ è‡ªåˆ†ã®å¤‰æ›´è¡Œæ•°: $(printf "%'d" $grand_my_lines)"
echo "ğŸŒ å…¨ä½“ã®å¤‰æ›´è¡Œæ•°: $(printf "%'d" $grand_total_lines)"
echo "ğŸ† ç·åˆè²¢çŒ®ã‚·ã‚§ã‚¢: ${grand_share}%"
echo ""

# è¨€èªåˆ¥é›†è¨ˆ
echo "ğŸ“ˆ ã€è‡ªåˆ†ã®æ‹¡å¼µå­åˆ¥å†…è¨³ã€‘"
echo "----------------------------------------"
printf "%-15s | %10s | %s\n" "Extension" "Lines" "Ratio"
echo "----------------------------------------"

awk -v total="$grand_my_lines" '
{
    lines = $1 + $2;
    file = tolower($3);
    m = split(file, names, "/");
    filename = names[m];
    n = split(filename, parts, ".");

    if (n > 1) {
        ext = parts[n];
        if (index(filename, ".blade.php") > 0) ext = "blade.php";
    } else { ext = filename; }

    if (ext ~ /[{}]/) ext = "unknown";
    if (ext == "") ext = "unknown";

    count[ext] += lines;
}
END {
    for (e in count) {
        ratio = (total > 0) ? (count[e] / total) * 100 : 0;
        printf "%s:%d:%.1f%%\n", e, count[e], ratio;
    }
}
' "$ALL_LOGS" | sort -t: -k2 -nr | awk -F: '{printf "%-15s | %10s | %6s\n", $1, sprintf("%'\''d", $2), $3}'
echo "----------------------------------------"
rm "$ALL_LOGS"