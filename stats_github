#!/bin/bash

# ==========================================
# „ÄêË®≠ÂÆö„Äë„Éá„Éï„Ç©„É´„ÉàÂÄ§ÔºàÁí∞Â¢ÉÂ§âÊï∞„Åß‰∏äÊõ∏„ÅçÂèØËÉΩÔºâ
# ==========================================
REPOS="${REPOS}"
LOCAL_ROOT="${REPOS_BASE_PATH}"
MONTHS_AGO="${STATS_GITHUB_MONTHS_AGO:-12}"
GIT_AUTHOR="${STATS_GITHUB_AUTHOR_PATTERN}"
EXCLUDE_PATTERN="${REPO_AUTHORS_EXCLUDE_PATTERN}"
MAX_LINES_LIMIT="${REPO_AUTHORS_MAX_LINES:-50000}"
MASTER_REPOS="${STATS_GITHUB_MASTER_REPOS}"
# ==========================================

# SINCE_DATE „ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Çå„Å∞ÂÑ™ÂÖà„ÄÅ„Å™„Åë„Çå„Å∞ MONTHS_AGO „Åã„ÇâË®àÁÆó
if [ -n "${STATS_GITHUB_SINCE_DATE}" ]; then
    SINCE_DATE="${STATS_GITHUB_SINCE_DATE}"
else
    if date -v -${MONTHS_AGO}m > /dev/null 2>&1; then
        # macOS
        SINCE_DATE=$(date -v -${MONTHS_AGO}m +%Y-%m-%d)
    else
        # Linux
        SINCE_DATE=$(date -d "${MONTHS_AGO} months ago" +%Y-%m-%d)
    fi
fi

ALL_LOGS=$(mktemp)

echo "üìä Ë≤¢ÁåÆ„Ç∑„Çß„Ç¢ÁéáÈõÜË®à (${SINCE_DATE} „Äú Êú¨Êó•)"
echo "üë§ User: \"$GIT_AUTHOR\""
echo "üì° Action: ÊúÄÊñ∞„ÅÆ origin/master(main) „ÇíÂèñÂæó„Åó„Å¶ÈõÜË®à"
echo "‚ö†Ô∏è  1„Éï„Ç°„Ç§„É´ ${MAX_LINES_LIMIT}Ë°å‰ª•‰∏ä„ÅÆÂ§âÊõ¥„ÅØÈô§Â§ñ"
echo "-----------------------------------------------------------------------------------------"
printf "%-20s | %-7s | %10s | %10s | %7s | %s\n" "Repository" "Branch" "My Lines" "Total Lines" "Share" "Note"
echo "-----------------------------------------------------------------------------------------"

grand_my_lines=0
grand_total_lines=0

for repo in $REPOS; do
    repo_path="${LOCAL_ROOT}/${repo}"

    # „Éñ„É©„É≥„ÉÅÂà§ÂÆöÔºàÁí∞Â¢ÉÂ§âÊï∞ÂåñÔºâ
    if echo " ${MASTER_REPOS} " | grep -q " ${repo} "; then
        TARGET_BRANCH="master"
    else
        TARGET_BRANCH="main"
    fi

    # ÈõÜË®àÂØæË±°„Çí„É™„É¢„Éº„ÉàËøΩË∑°„Éñ„É©„É≥„ÉÅ„Å´„Åô„Çã (origin/master)
    TARGET_REF="origin/$TARGET_BRANCH"

    if [ -d "$repo_path/.git" ]; then
        # ---------------------------------------------------------
        # 0. ÊúÄÊñ∞ÊÉÖÂ†±„ÇíÂèñÂæó (Fetch)
        # ---------------------------------------------------------
        git -C "$repo_path" fetch origin "$TARGET_BRANCH" >/dev/null 2>&1

        # ÊåáÂÆö„Éñ„É©„É≥„ÉÅ(„É™„É¢„Éº„Éà)„ÅåÂ≠òÂú®„Åô„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
        if ! git -C "$repo_path" rev-parse --verify "$TARGET_REF" >/dev/null 2>&1; then
            printf "%-20s | %-7s |      -     |      -     |    -   | (Remote branch not found)\n" "${repo:0:20}" "$TARGET_BRANCH"
            continue
        fi

        # ---------------------------------------------------------
        # 1. Ëá™ÂàÜ„ÅÆË°åÊï∞„ÇíË®àÁÆó
        # ---------------------------------------------------------

        # „É≠„Ç∞‰øùÂ≠ò (Êã°ÂºµÂ≠êÈõÜË®àÁî®)
        git -C "$repo_path" log "$TARGET_REF" --author="$GIT_AUTHOR" -i --since="$SINCE_DATE" --no-merges --numstat --format="" --no-renames \
            | grep -vE "$EXCLUDE_PATTERN" \
            | awk -v limit="$MAX_LINES_LIMIT" '{ if ($1 ~ /^[0-9]+$/ && ($1+$2) <= limit) print $0 }' \
            >> "$ALL_LOGS"

        # Êï∞ÂÄ§Ë®àÁÆó & Èô§Â§ñ„Éï„Ç°„Ç§„É´„ÉÅ„Çß„ÉÉ„ÇØ
        output_me=$(git -C "$repo_path" log "$TARGET_REF" --author="$GIT_AUTHOR" -i --since="$SINCE_DATE" --no-merges --numstat --format="" --no-renames \
            | grep -vE "$EXCLUDE_PATTERN" \
            | awk -v limit="$MAX_LINES_LIMIT" '
                BEGIN {sum=0; skip=0; files=""}
                {
                    if ($1 !~ /^[0-9]+$/) next;
                    lines = $1 + $2;

                    if (lines > limit) {
                        skip++;
                        entry = $3 ": " lines;
                        if (files == "") files = entry;
                        else files = files ", " entry;
                    }
                    else {
                        sum += lines;
                    }
                }
                END {printf "%d\t%d\t%s", sum, skip, files}'
        )

        IFS=$'\t' read my_lines my_skip my_ignored_files <<< "$output_me"
        unset IFS

        # ---------------------------------------------------------
        # 2. ÂÖ®‰Ωì„ÅÆË°åÊï∞„ÇíË®àÁÆó
        # ---------------------------------------------------------
        output_total=$(git -C "$repo_path" log "$TARGET_REF" --since="$SINCE_DATE" --no-merges --numstat --format="" --no-renames \
            | grep -vE "$EXCLUDE_PATTERN" \
            | awk -v limit="$MAX_LINES_LIMIT" '
                BEGIN {sum=0}
                {
                    if ($1 !~ /^[0-9]+$/) next;
                    if (($1+$2) <= limit) sum+=$1+$2
                }
                END {printf "%d", sum}'
        )
        total_lines="$output_total"

        # 3. „Ç∑„Çß„Ç¢Áéá & NoteË°®Á§∫
        if [ "$total_lines" -gt 0 ]; then
            share=$(awk "BEGIN {printf \"%.1f\", ($my_lines / $total_lines) * 100}")
        else
            share="0.0"
        fi

        note=""
        if [ "$my_skip" -gt 0 ]; then
            note="(${my_skip} ignored: ${my_ignored_files})"
        fi

        printf "%-20s | %-7s | %10s | %10s | %6s%% | %s\n" \
            "${repo:0:20}" "$TARGET_BRANCH" "$(printf "%'d" $my_lines)" "$(printf "%'d" $total_lines)" "$share" "$note"

        grand_my_lines=$((grand_my_lines + my_lines))
        grand_total_lines=$((grand_total_lines + total_lines))
    else
        printf "%-20s | %-7s |      -     |      -     |    -   | (Repo not found)\n" "${repo:0:20}" "$TARGET_BRANCH"
    fi
done

echo "-----------------------------------------------------------------------------------------"

if [ "$grand_total_lines" -gt 0 ]; then
    grand_share=$(awk "BEGIN {printf \"%.1f\", ($grand_my_lines / $grand_total_lines) * 100}")
else
    grand_share="0.0"
fi

echo "üìù Ëá™ÂàÜ„ÅÆÂ§âÊõ¥Ë°åÊï∞: $(printf "%'d" $grand_my_lines)"
echo "üåç ÂÖ®‰Ωì„ÅÆÂ§âÊõ¥Ë°åÊï∞: $(printf "%'d" $grand_total_lines)"
echo "üèÜ Á∑èÂêàË≤¢ÁåÆ„Ç∑„Çß„Ç¢: ${grand_share}%"
echo ""

# Ë®ÄË™ûÂà•ÈõÜË®à
echo "üìà „ÄêËá™ÂàÜ„ÅÆÊã°ÂºµÂ≠êÂà•ÂÜÖË®≥„Äë"
echo "----------------------------------------"
printf "%-15s | %10s | %s\n" "Extension" "Lines" "Ratio"
echo "----------------------------------------"

awk -v total="$grand_my_lines" '
{
    lines = $1 + $2;
    file = tolower($3);
    m = split(file, names, "/");
    filename = names[m];
    n = split(filename, parts, ".");

    if (n > 1) {
        ext = parts[n];
        if (index(filename, ".blade.php") > 0) ext = "blade.php";
    } else { ext = filename; }

    if (ext ~ /[{}]/) ext = "unknown";
    if (ext == "") ext = "unknown";

    count[ext] += lines;
}
END {
    for (e in count) {
        ratio = (total > 0) ? (count[e] / total) * 100 : 0;
        printf "%s:%d:%.1f%%\n", e, count[e], ratio;
    }
}
' "$ALL_LOGS" | sort -t: -k2 -nr | awk -F: '{printf "%-15s | %10s | %6s\n", $1, sprintf("%'\''d", $2), $3}'
echo "----------------------------------------"
rm "$ALL_LOGS"