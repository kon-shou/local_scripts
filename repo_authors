#!/bin/bash

# ãƒ˜ãƒ«ãƒ—é–¢æ•°
show_help() {
  cat << EOF
Usage: $0 [OPTIONS]

Show author contribution ranking for Git repositories.

Options:
  --months-ago=N        Show statistics for the last N months
  --months-ago N        (alternative format)
  --since=YYYY-MM-DD    Show statistics since the specified date
  --since YYYY-MM-DD    (alternative format)
  -h, --help            Show this help message

Examples:
  $0 --months-ago=12
  $0 --since=2024-01-01

Environment Variables:
  REPOS                 List of repositories to analyze (required)
  REPOS_BASE_PATH       Base directory for repositories (default: \$HOME)
  STATS_GITHUB_MASTER_REPOS  Space-separated list of repos using 'master' branch
  REPO_AUTHORS_EXCLUDE_PATTERN  Pattern to exclude from statistics
  REPO_AUTHORS_MAX_LINES  Maximum lines threshold (default: 50000)

Description:
  This script analyzes Git repositories and shows author contribution
  rankings based on changed lines. Large files and specified patterns
  are automatically excluded.
EOF
}

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
MONTHS_AGO=""
SINCE_DATE=""

# ã‚ªãƒ—ã‚·ãƒ§ãƒ³è§£æ
while [[ $# -gt 0 ]]; do
  case $1 in
    --months-ago)
      MONTHS_AGO="$2"
      shift 2
      ;;
    --months-ago=*)
      MONTHS_AGO="${1#*=}"
      shift
      ;;
    --since)
      SINCE_DATE="$2"
      shift 2
      ;;
    --since=*)
      SINCE_DATE="${1#*=}"
      shift
      ;;
    -h|--help)
      show_help
      exit 0
      ;;
    -*)
      echo "Error: Unknown option: $1" >&2
      echo "Try '$0 --help' for more information." >&2
      exit 1
      ;;
    *)
      # ä½ç½®å¼•æ•°ã¯ã‚¨ãƒ©ãƒ¼ï¼ˆå¾Œæ–¹äº’æ›æ€§ãªã—ï¼‰
      echo "Error: Unexpected argument: $1" >&2
      echo "Use --months-ago or --since option instead." >&2
      echo "Try '$0 --help' for more information." >&2
      exit 1
      ;;
  esac
done

# å¿…é ˆãƒã‚§ãƒƒã‚¯
if [ -z "$MONTHS_AGO" ] && [ -z "$SINCE_DATE" ]; then
  echo "Error: Either --months-ago or --since is required" >&2
  echo "Try '$0 --help' for more information." >&2
  exit 1
fi

# --since ãŒæŒ‡å®šã•ã‚ŒãŸå ´åˆã¯å„ªå…ˆ
if [ -n "$SINCE_DATE" ]; then
  # æ—¥ä»˜å½¢å¼ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  if ! [[ "$SINCE_DATE" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
    echo "Error: --since must be in YYYY-MM-DD format" >&2
    exit 1
  fi
  # æœ‰åŠ¹ãªæ—¥ä»˜ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆmacOS/Linuxä¸¡å¯¾å¿œï¼‰
  if date -j -f "%Y-%m-%d" "$SINCE_DATE" > /dev/null 2>&1; then
    : # macOS: æ—¥ä»˜ãŒæœ‰åŠ¹
  elif date -d "$SINCE_DATE" > /dev/null 2>&1; then
    : # Linux: æ—¥ä»˜ãŒæœ‰åŠ¹
  else
    echo "Error: Invalid date: $SINCE_DATE" >&2
    exit 1
  fi
elif [ -n "$MONTHS_AGO" ]; then
  # æ•°å€¤ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  if ! [[ "$MONTHS_AGO" =~ ^[0-9]+$ ]]; then
    echo "Error: --months-ago must be a positive integer" >&2
    exit 1
  fi
  # SINCE_DATE ã‚’è¨ˆç®—ï¼ˆmacOS/Linuxä¸¡å¯¾å¿œï¼‰
  if date -v -${MONTHS_AGO}m > /dev/null 2>&1; then
    SINCE_DATE=$(date -v -${MONTHS_AGO}m +%Y-%m-%d)
  else
    SINCE_DATE=$(date -d "${MONTHS_AGO} months ago" +%Y-%m-%d)
  fi
fi

# ==========================================
# ã€è¨­å®šã€‘ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆç’°å¢ƒå¤‰æ•°ã§ä¸Šæ›¸ãå¯èƒ½ï¼‰
# ==========================================
LOCAL_ROOT="${REPOS_BASE_PATH:-$HOME}"
MASTER_REPOS="${STATS_GITHUB_MASTER_REPOS}"
EXCLUDE_PATTERN="${REPO_AUTHORS_EXCLUDE_PATTERN}"

# é™¤å¤–ãƒ‘ã‚¿ãƒ¼ãƒ³ & è¡Œæ•°åˆ¶é™
MAX_LINES_LIMIT="${REPO_AUTHORS_MAX_LINES:-50000}"
# ==========================================

echo "ğŸ“Š Authoråˆ¥ å¤‰æ›´è¡Œæ•°ãƒ©ãƒ³ã‚­ãƒ³ã‚° (${SINCE_DATE} ã€œ æœ¬æ—¥)"
echo "âš ï¸  é™¤å¤–æ¡ä»¶: magicpod, lockãƒ•ã‚¡ã‚¤ãƒ«, 1ãƒ•ã‚¡ã‚¤ãƒ«${MAX_LINES_LIMIT}è¡Œä»¥ä¸Š"
echo "======================================================================"

for repo in $REPOS; do
    repo_path="${LOCAL_ROOT}/${repo}"

    # ãƒ–ãƒ©ãƒ³ãƒåˆ¤å®šï¼ˆç’°å¢ƒå¤‰æ•°åŒ–ï¼‰
    if echo " ${MASTER_REPOS} " | grep -q " ${repo} "; then
        TARGET_BRANCH="master"
    else
        TARGET_BRANCH="main"
    fi
    TARGET_REF="origin/$TARGET_BRANCH"

    if [ -d "$repo_path/.git" ]; then
        echo ""
        echo "ğŸ“‚ [${repo}] (Branch: ${TARGET_BRANCH})"
        echo "--------------------------------------------------"

        # 1. Fetch
        git -C "$repo_path" fetch origin "$TARGET_BRANCH" >/dev/null 2>&1

        # 2. ãƒ­ã‚°å–å¾— & é›†è¨ˆ
        git -C "$repo_path" log "$TARGET_REF" --since="$SINCE_DATE" --no-merges --numstat --format="AUTHOR:%an" --no-renames \
            | grep -vE "$EXCLUDE_PATTERN" \
            | awk -v limit="$MAX_LINES_LIMIT" '
                /^AUTHOR:/ {
                    current_auth = substr($0, 8);
                    next;
                }
                {
                    if ($1 ~ /^[0-9]+$/) {
                        lines = $1 + $2;
                        if (lines <= limit) {
                            sum[current_auth] += lines;
                        }
                    }
                }
                END {
                    for (auth in sum) {
                        printf "%d\t%s\n", sum[auth], auth;
                    }
                }
            ' \
            | sort -nr \
            | awk '{
                lines=$1;
                $1="";
                sub(/^ /, ""); # å…ˆé ­ã®ã‚¹ãƒšãƒ¼ã‚¹å‰Šé™¤
                printf "  %2d. %-30s : %'\''d lines\n", NR, $0, lines
            }' | head -n 15

    else
        echo "âŒ [${repo}] Not found"
    fi
done

echo ""
echo "======================================================================"