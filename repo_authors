#!/bin/bash

# ==========================================
# „ÄêË®≠ÂÆö„Äë„Éá„Éï„Ç©„É´„ÉàÂÄ§ÔºàÁí∞Â¢ÉÂ§âÊï∞„Åß‰∏äÊõ∏„ÅçÂèØËÉΩÔºâ
# ==========================================
LOCAL_ROOT="${REPOS_BASE_PATH:-$HOME}"
MONTHS_AGO="${REPO_AUTHORS_MONTHS_AGO:-12}"
MASTER_REPOS="${STATS_GITHUB_MASTER_REPOS}"
EXCLUDE_PATTERN="${REPO_AUTHORS_EXCLUDE_PATTERN}"

# Èô§Â§ñ„Éë„Çø„Éº„É≥ & Ë°åÊï∞Âà∂Èôê
MAX_LINES_LIMIT="${REPO_AUTHORS_MAX_LINES:-50000}"
# ==========================================

if date -v -${MONTHS_AGO}m > /dev/null 2>&1; then
    SINCE_DATE=$(date -v -${MONTHS_AGO}m +%Y-%m-%d)
else
    SINCE_DATE=$(date -d "${MONTHS_AGO} months ago" +%Y-%m-%d)
fi

echo "üìä AuthorÂà• Â§âÊõ¥Ë°åÊï∞„É©„É≥„Ç≠„É≥„Ç∞ (${SINCE_DATE} „Äú Êú¨Êó•)"
echo "‚ö†Ô∏è  Èô§Â§ñÊù°‰ª∂: magicpod, lock„Éï„Ç°„Ç§„É´, 1„Éï„Ç°„Ç§„É´${MAX_LINES_LIMIT}Ë°å‰ª•‰∏ä"
echo "======================================================================"

for repo in $REPOS; do
    repo_path="${LOCAL_ROOT}/${repo}"

    # „Éñ„É©„É≥„ÉÅÂà§ÂÆöÔºàÁí∞Â¢ÉÂ§âÊï∞ÂåñÔºâ
    if echo " ${MASTER_REPOS} " | grep -q " ${repo} "; then
        TARGET_BRANCH="master"
    else
        TARGET_BRANCH="main"
    fi
    TARGET_REF="origin/$TARGET_BRANCH"

    if [ -d "$repo_path/.git" ]; then
        echo ""
        echo "üìÇ [${repo}] (Branch: ${TARGET_BRANCH})"
        echo "--------------------------------------------------"

        # 1. Fetch
        git -C "$repo_path" fetch origin "$TARGET_BRANCH" >/dev/null 2>&1

        # 2. „É≠„Ç∞ÂèñÂæó & ÈõÜË®à
        git -C "$repo_path" log "$TARGET_REF" --since="$SINCE_DATE" --no-merges --numstat --format="AUTHOR:%an" --no-renames \
            | grep -vE "$EXCLUDE_PATTERN" \
            | awk -v limit="$MAX_LINES_LIMIT" '
                /^AUTHOR:/ {
                    current_auth = substr($0, 8);
                    next;
                }
                {
                    if ($1 ~ /^[0-9]+$/) {
                        lines = $1 + $2;
                        if (lines <= limit) {
                            sum[current_auth] += lines;
                        }
                    }
                }
                END {
                    for (auth in sum) {
                        printf "%d\t%s\n", sum[auth], auth;
                    }
                }
            ' \
            | sort -nr \
            | awk '{
                lines=$1;
                $1="";
                sub(/^ /, ""); # ÂÖàÈ†≠„ÅÆ„Çπ„Éö„Éº„ÇπÂâäÈô§
                printf "  %2d. %-30s : %'\''d lines\n", NR, $0, lines
            }' | head -n 15

    else
        echo "‚ùå [${repo}] Not found"
    fi
done

echo ""
echo "======================================================================"