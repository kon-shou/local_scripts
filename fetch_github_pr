#!/bin/bash

# コマンド引数から日付を取得（必須）
if [ -z "$1" ] || [ -z "$2" ]; then
  echo "Error: START_DATE and END_DATE are required" >&2
  echo "Usage: $0 START_DATE END_DATE" >&2
  echo "Example: $0 2025-04-01 2025-12-31" >&2
  exit 1
fi

START_DATE="$1"
END_DATE="$2"

echo "期間: ${START_DATE} - ${END_DATE}"
echo ""

for d in $REPOS; do
  echo "#### $d"

  gh pr list --author="$AUTHOR" --repo="$ORGANIZATION/${d}" --state="merged" --search="updated:${START_DATE}T00:00:00+09:00..${END_DATE}T23:59:59+09:00" \
  --limit=1000 --json number,title,headRefName,baseRefName,additions,deletions --jq '.[] | select(.baseRefName == "main" or .baseRefName == "development") | [.headRefName, .number, .title, .additions, .deletions] | join("@@@@@@@@@@@@")' \
  | grep -vE '^hotfix/' | grep -vE '^release/' | grep -vE '^development@' \
  | awk -F '@@@@@@@@@@@@' '{print " - [#" $2 " " $3 "](https://github.com/'$ORGANIZATION'/'${d}'/pull/"$2 ") (+" $4 " -" $5 ")"}' \
  | tac

  echo ""
done;

echo "------"
echo "### 変更行数が1000行以上のPR"
echo ""

for d in $REPOS; do
  LARGE_PRS=$(gh pr list --author="$AUTHOR" --repo="$ORGANIZATION/${d}" --state="merged" --search="updated:${START_DATE}T00:00:00+09:00..${END_DATE}T23:59:59+09:00" \
  --limit=1000 --json number,title,headRefName,baseRefName,additions,deletions --jq '.[] | select(.baseRefName == "main" or .baseRefName == "development") | select((.additions + .deletions) >= 1000) | [.headRefName, .number, .title, .additions, .deletions] | join("@@@@@@@@@@@@")' \
  | grep -vE '^hotfix/' | grep -vE '^release/' | grep -vE '^development@' \
  | awk -F '@@@@@@@@@@@@' '{print "    - [#" $2 " " $3 "](https://github.com/'$ORGANIZATION'/'${d}'/pull/"$2 ") (+" $4 " -" $5 ")"}' \
  | tac)

  if [ -n "$LARGE_PRS" ]; then
    echo "- $d"
    echo "$LARGE_PRS"
  fi
done;
